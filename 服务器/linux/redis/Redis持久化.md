## Redis持久化

#### 一.RDB 持久化机制

##### 1.RDB 的概念

RDB（Redis DataBase）是 Redis 的一种持久化方式，它用于将当前内存中的数据保存到硬盘上的一个快照（snapshot）文件中。这个快照文件包含了一个特定时刻的所有数据，包括键值对、数据结构等。RDB 的工作方式类似于数据库的备份，它将内存中的数据定期保存到一个持久化文件中，以便在需要时进行数据恢复。

##### 2.RDB 持久化机制的优缺点

**优点：**

- **高性能：** RDB持久化机制，因为RDB是通过 fork 子进程来完成的，主进程不需要执行繁重的 IO 操作，这可以确保Redis 在生成 RDB 快照时保持高吞吐量。
- **紧凑和可读性好：** RDB 文件采用了一种高效的二进制格式，相对于aof保存数据文件更小
- **备份和迁移： **由于 RDB 文件的紧凑性和可读性，它非常适用于备份数据或在不同环境之间迁移 Redis 数据。

**缺点：**

- **数据可能有损失：** RDB 是定期生成的快照文件，如果 Redis 服务器在生成快照之间崩溃，可能会丢失最后一次快照之后的数据。

##### 3.RDB配置

1. Redis通过`redis.conf`中进行相关配置

   ```sh
   # 设置保存快照的频率
   save 900 1        # 表示在900秒（15分钟）内，如果至少有1个键发生变化，就会触发RDB快照保存。
   save 300 10       # 表示在300秒（5分钟）内，如果至少有10个键发生变化，就会触发RDB快照保存。
   save 60 10000     # 表示在60秒内，如果至少有10000个键发生变化，就会触发RDB快照保存。
   
   # 指定RDB快照文件的名称
   dbfilename dump.rdb
   
   # # 指定RDB文件的保存路径
   dir /var/lib/redis
   
   # 禁用自动RDB持久化
   save ""
   
   # 开启 RDB 文件压缩（默认情况下是开启的）
   rdbcompression yes
   
    # 在保存RDB文件时是否进行校验和检查（默认情况下是开启的）
   rdbchecksum yes
   ```

2. 自动触发和手动触发

   **SAVE命令：** 使用 SAVE 命令可以立即生成一个 RDB 快照，它会`阻塞` Redis 服务器，直到 RDB 快照生成完成为止。（不推荐）

   **BGSAVE命令：** 使用 BGSAVE 命令可以在后台生成 RDB 快照，而不会阻塞 Redis 服务器的正常操作，（推荐）

#### 二.AOF 持久化机制

##### 1.AOF 持久化机制

AOF（Append-Only File）是 Redis 的一种持久化机制，用于将 Redis 服务器的写操作以追加的方式记录到一个文本文件中，从而实现数据持久化。每个写操作都会以 Redis 命令的形式追加到 AOF 文件的末尾，因此 AOF 文件是一个按照时间顺序记录写操作的日志文件。

##### 2.AOF 的优缺点

**优点：**

- **数据安全性：**AOF 记录了每个写操作，因此在服务器故障或崩溃时，只会丢失最后一次写操作之后的数据。这提供了较高的数据安全性。

- **可读性：**AOF 文件是一个文本文件，易于人类阅读和理解。这使得AOF文件在需要手动恢复数据或进行调试时非常有用。

- **灵活性：**AOF 文件的追加方式写入使得数据持久化非常实时，可以根据需求选择不同的同步策略，从完全同步到异步。

- **自动重写：**Redis 提供了 AOF 文件的自动重写机制，可以避免 AOF 文件过大，提高了性能。

**缺点：**

- **文件体积：**相对于 RDB 持久化，AOF 文件通常较大，因为它包含了每个写操作的命令文本。这可能会占用较多的磁盘空间。

- **写入性能：**AOF 持久化会导致每个写操作都需要追加到 AOF 文件中，这可能会对写入性能产生一定的影响，尤其是在使用同步写入策略时。

##### 3.AOF配置

```sh
# 用于启用或禁用AOF持久化。设置为"yes"表示启用AOF，设置为"no"表示禁用。默认AOF持久化是禁用
appendonly yes

# 指定AOF文件的文件名，默认为"appendonly.aof"。您可以根据需要更改文件名。
appendfilename "appendonly.aof"

# no: Redis不会主动调用fsync去将AOF日志内容同步到磁盘，所以这一切就完全依赖于操作系统的调试了。对大多数Linux操作系统，是每30秒进行一次fsync
# everysec: 当设置appendfsync为everysec的时候，Redis会默认每隔一秒进行一次fsync调用，将缓冲区中的数据写到磁盘
# always: 每一次写操作都会调用一次fsync，这时数据是最安全的，当然，由于每次都会执行fsync，所以其性能也会受到影响
appendfsync everysec # 推荐使用everysec
```

